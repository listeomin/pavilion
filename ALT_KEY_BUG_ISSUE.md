# Bug: Alt key auto-submits after sending message via Enter

## Описание проблемы

После отправки сообщения по клавише **Enter**, нажатие клавиши **Alt** для навигации по командам (`/music`, `/rebase`) приводит к немедленной автоотправке команды вместо простого отображения.

## Воспроизведение

1. Написать любое сообщение в поле ввода
2. Отправить сообщение нажав **Enter**
3. Не покидая поле ввода, нажать и отпустить клавишу **Alt**
4. **Ожидаемое поведение**: Появляется команда `/music` или `/rebase`, можно продолжить редактирование
5. **Фактическое поведение**: Команда появляется и сразу же отправляется (автосабмит)

## Когда бага НЕ проявляется

✅ **Работает корректно:**
- После обновления страницы (первое использование поля)
- После отправки сообщения **кликом по кнопке "Лапка"** или "Отправить"
- После отправки сообщения по клавише **F18** (тестовый обработчик)
- Если после отправки покинуть поле (blur) и вернуться (focus) - вручную кликнуть в поле

❌ **Бага проявляется:**
- Только после отправки сообщения по клавише **Enter**
- Только если остаться в поле ввода (не уходить курсором)

## Ключевые открытия

### 1. Проблема специфична для клавиши Enter
- Отправка через кнопку → Alt работает ✓
- Отправка через F18 → Alt работает ✓
- Отправка через Enter → Alt с багой ✗

### 2. Проблема в клавише, а не в submit handler
Все три метода (кнопка, F18, Enter) вызывают один и тот же `submit` handler, но только Enter создаёт проблемное состояние.

### 3. Состояние поля после отправки
Из логов было видно что после отправки через Enter:
- `editor.paused: true` (иногда)
- `inlineInput.commandMode: true` (иногда)
- При нажатии Alt текст становится `/music ` (с пробелом в конце!)
- Генерируются синтетические события: Backspace, 'q', Enter

### 4. Разница между программным и ручным фокусом
- Ручной клик в поле после blur → работает ✓
- Программный `focus()` после blur → НЕ работает ✗
- Программный `click()` после blur → НЕ работает ✗
- Программные MouseEvent после blur → НЕ работает ✗

## Что НЕ помогло

Испробованные решения (не сработали):
1. ❌ Добавление `e.stopPropagation()` и `e.stopImmediatePropagation()` к Enter
2. ❌ Блокировка Enter keyup события
3. ❌ Обработка Enter в capture phase (раньше всех обработчиков)
4. ❌ Полный сброс contenteditable (`contentEditable='false'` → очистка → `'true'`)
5. ❌ Blur + setTimeout + focus/click/MouseEvent
6. ❌ Замена `sendForm.dispatchEvent()` на `sendBtn.click()`
7. ❌ Проверка и сброс `editor.paused`, `inlineInput.commandMode`

## Временное решение (workaround)

Использовать клавишу **F18** для отправки вместо Enter - работает без багов.

Код в `hotkeys.js`:
```javascript
// TEST: F18 to submit
if (e.key === 'F18') {
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();
  onSubmit();
  return;
}
```

## Текущая гипотеза

Проблема скорее всего в том, что:
1. InlineInput обрабатывает события раньше чем hotkeys (listeners добавлены раньше)
2. При нажатии Enter, InlineInput получает какое-то событие (возможно beforeinput или input)
3. Это событие переводит InlineInput в некорректное состояние
4. После submit это состояние сохраняется
5. При следующем нажатии Alt, InlineInput обрабатывает его неправильно из-за сохранённого состояния

## Потенциальные направления исследования

1. **Проверить beforeinput события**: Возможно Enter генерирует beforeinput с типом "insertParagraph" который InlineInput обрабатывает по-особому

2. **Изучить порядок событий**: Добавить детальное логирование всех событий (beforeinput, input, keydown, keyup) при нажатии Enter vs F18

3. **Состояние InlineInput**: Проверить все внутренние переменные InlineInput до и после Enter/F18

4. **Изоляция InlineInput от Enter**: Попробовать полностью изолировать InlineInput от событий Enter (остановить все события до того как они дойдут до InlineInput)

5. **Пересоздание инстанса**: После submit пересоздавать инстанс InlineInput заново (радикальный подход)

## Файлы с изменениями

### Основные файлы:
- `public/js/hotkeys.js` - обработка клавиатурных событий (Enter, Alt, F18)
- `public/js/main.js` - submit handler, cleanup после отправки
- `public/js/inline-input.js` - обработка командного режима (/music, /rebase)
- `public/js/editor.js` - управление состоянием contenteditable

### Важные функции:
- `hotkeys.js`: `setupHotkeys()` - строка 187-191 (Enter submit)
- `main.js`: form submit handler - строка 96-256
- `inline-input.js`: `handleKeydown()`, `handleBeforeInput()`, `handleInput()`

## Среда

- Браузер: (добавить информацию)
- ОС: (добавить информацию)
- ContentEditable element
- События обрабатываются через addEventListener

## Приоритет

**High** - баг влияет на основной UX при использовании клавиатуры для быстрой навигации по командам.

## Комментарии

Отладка велась ~3 часа. Основной прорыв - обнаружение что F18 работает, а Enter нет, при идентичном коде обработки. Это указывает на то, что проблема в самой клавише Enter или в том как браузер/InlineInput её обрабатывает, а не в нашем коде обработки submit.
