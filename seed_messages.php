<?php
// seed_messages.php - –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

require_once __DIR__ . '/server/db.php';
require_once __DIR__ . '/server/SessionRepository.php';
require_once __DIR__ . '/server/MessageRepository.php';

$db = get_db();
$sessionRepo = new SessionRepository();
$msgRepo = new MessageRepository();

// –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
$db->exec('DELETE FROM messages');
$db->exec('DELETE FROM sessions');

// –î–∏–∞–ª–æ–≥ –¥–ª—è —á–∞—Ç–∞
$messages = [
    [
        'name' => 'üê∫ –≤—É–ª—å–≤',
        'text' => '–°–ª—É—Ö, –∞ –ø–æ—á–µ–º—É —É –Ω–∞—Å API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML –≤–º–µ—Å—Ç–æ JSON? –ß—Ç–æ –∑–∞ –¥–∏—á—å, —è –Ω–µ –ø–æ–π–º—É ))'
    ],
    [
        'name' => 'ü¶â —Å–æ–≤—É–Ω',
        'text' => '–¢—ã —Ä–æ—É—Ç–µ—Ä –∑–∞–±—ã–ª –ø—Ä–æ–ø–∏—Å–∞—Ç—å, PHP dev server –Ω–µ –∑–Ω–∞–µ—Ç –∫—É–¥–∞ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–µ–±–∞–ª!'
    ],
    [
        'name' => 'ü¶ä –ª–∏—Å—É—Å',
        'text' => '–î–∞ –º—ã –≤—á–µ—Ä–∞ —Ñ–∏–∫—Å–∏–ª–∏! –ù—É–∂–Ω–æ —Å —Ñ–ª–∞–≥–æ–º -t public –∑–∞–ø—É—Å–∫–∞—Ç—å –∏ router.php –¥–æ–±–∞–≤–∏—Ç—å, –∞–ª–æ!'
    ],
    [
        'name' => 'üê∫ –≤—É–ª—å–≤',
        'text' => '–ë–ª—è, —Ç–æ—á–Ω–æ... –°–ø–∞—Å–∏–±–æ.'
    ],
    [
        'name' => 'ü¶î –µ–∂–∏—Ö–∞',
        'text' => '–ö—Å—Ç–∞—Ç–∏, —á—Ç–æ —Å–ª—ã—à–Ω–æ –ø—Ä–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É? –ü–æ-–º–æ–µ–º—É –æ–Ω —Å–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–∏–π, –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –ø–æ–º—è–≥—á–µ?'
    ],
];

// –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏–∏ —Å –Ω—É–∂–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
foreach ($messages as $msg) {
    // –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é —Å –Ω—É–∂–Ω—ã–º –∏–º–µ–Ω–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ –±–∞–∑–µ
    $id = bin2hex(random_bytes(16));
    $now = (new DateTime())->format(DateTime::ATOM);
    
    $stmt = $db->prepare('INSERT OR REPLACE INTO sessions (id, name, created_at) VALUES (:id, :name, :created_at)');
    $stmt->execute([
        ':id' => $id,
        ':name' => $msg['name'],
        ':created_at' => $now
    ]);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    $msgRepo->add($id, $msg['name'], $msg['text']);
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
    usleep(100000); // 0.1 —Å–µ–∫—É–Ω–¥—ã
}

echo "–ë–∞–∑–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–æ–º!\n";
echo "–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: " . count($messages) . "\n";
