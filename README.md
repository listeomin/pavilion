# Hhrrr Pavilion
Минималистичный анонимный чат на отдельной странице: **`hhrrr.ru/chat`**.

## Что работает
* Отдельная страница `/chat` с минимальным интерфейсом.  
* Анонимные сессии с автогенерацией псевдонимов `user_XXX`.  
* Общая история сообщений, хранимая в SQLite.  
* Первичный показ ограниченной страницы истории для новых посетителей; полная история для возвращающихся по сессии.  
* Отправка сообщений без перезагрузки страницы; обновление через опрос сервера (polling).  
* Простое HTTP API с методами инициализации, отправки и получения новых сообщений.

## Архитектура
```
chat/  
├─ index.php              # фронтенд-страница чата + минимальный JS  
├─ api.php                # HTTP‑API (init, send, poll)  
├─ db.php                 # подключение к SQLite и первичная миграция  
├─ SessionRepository.php  # работа с сессиями и генерация имён  
├─ MessageRepository.php  # запись/чтение сообщений  
└─ chat.sqlite            # база данных (создаётся автоматически)  
```

## Данные
**sessions**  
`id` — UUID/hex, primary key  
`name` — псевдоним (`user_001`, `user_002`, …)  
`created_at` — ISO‑дата создания  
**messages**  
`id` — автоинкремент  
`session_id` — связь с sessions.id  
`author` — строка с именем (user_XXX)  
`text` — текст сообщения  
`created_at` — ISO‑дата/время

## Поток работы
**Инициализация сессии** (api.php?action=init)  
Клиент отправляет cookie `chat_session_id` (если есть).  
API возвращает существующую сессию или создаёт новую и отдаёт соответствующую часть истории.  
**Отправка сообщения** (api.php?action=send)  
Принимается `session_id` и `text`, проверяется сессия, сообщение сохраняется и возвращается созданный объект.  
**Получение новых сообщений** (api.php?action=poll)  
Запрос `action=poll&after_id=...` возвращает сообщения с `id > after_id`.  
**Фронтенд** (index.php)  
Инициализация, рендер истории, отправка сообщений через AJAX, периодический опрос сервера.

## Модули и обязанности файлов
**db.php:** подключение к SQLite (`chat.sqlite`) и первичная миграция таблиц.  
**SessionRepository.php:** получение и создание сессий; генерация уникальных имён.  
**MessageRepository.php:** добавление сообщений; чтение всей истории, последних N записей и сообщений после заданного id.  
**api.php:** простое JSON API: `init`, `send`, `poll`.  
**index.php:**  минимальный HTML/JS интерфейс и логика опроса/отправки.

## Поведение для первого и повторного визита
**Первый визит**: cоздаётся новая сессия; клиент получает ограниченную страницу истории.  
**Повторный визит:**  cессия подтягивается по cookie; клиент получает полную историю и продолжает обмен сообщениями.

## Окружение

**Рекомендуемое окружение**
- **ОС:** Linux (Debian/Ubuntu)  
- **Веб‑сервер:** nginx + php‑fpm или Apache + mod_php  
- **PHP:** 7.4+ (рекомендуется 8.x) с поддержкой PDO и SQLite  
- **SQLite:** библиотека и PHP‑модуль `pdo_sqlite`  
- **Права:** веб‑процесс должен иметь права на запись в каталог проекта для создания `chat.sqlite`

**Обнаружено на сервере (пример из текущей установки)**
- **PHP (CLI):** PHP 8.3.6  
- **nginx:** nginx/1.24.0  
- **PHP модули:** pdo_sqlite, sqlite3 (подключены)  
- **Apache:** не установлен / не используется в текущей конфигурации.
