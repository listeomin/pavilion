# ⚠️ Инструкция по очистке

## Шаг 1: Удалить файлы из корня проекта

Эти файлы уже скопированы в папку `Удоли/` для сохранности:

```bash
rm migrate.php
rm migrate_add_metadata.php
rm ._migrate.php
rm test-fallback.sh
```

## Шаг 2: Удалить код из существующих файлов

### server/api.php

Найти и удалить (строки 56-59):
```php
if ($action === 'poll') {
    $result = $handler->poll($_GET);
    json($result);
}
```

### server/ApiHandler.php

Найти и удалить метод `poll()` (~строки 86-90):
```php
public function poll(array $query): array {
    $after = isset($query['after_id']) && $query['after_id'] !== '' ? intval($query['after_id']) : null;
    $messages = $this->msgRepo->getSinceId($after);
    return ['messages' => $messages];
}
```

### server/MessageRepository.php

Найти и удалить метод `getSinceId()` (~строки 52-59):
```php
public function getSinceId(?int $afterId): array {
    if ($afterId === null) {
        return $this->getAll();
    }
    $stmt = $this->db->prepare('SELECT id, session_id, author, text, metadata, created_at FROM messages WHERE id > :after ORDER BY id ASC');
    $stmt->execute([':after' => $afterId]);
    return $this->decodeMetadata($stmt->fetchAll(PDO::FETCH_ASSOC));
}
```

### public/js/api.js

Найти и удалить функцию `apiPoll()` (~строки 33-38):
```javascript
export async function apiPoll(API, lastId) {
  const url = API + '?action=poll&after_id=' + encodeURIComponent(lastId);
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) return null;
  return await res.json();
}
```

## Шаг 3: Проверить тесты

```bash
./run_tests.sh
```

Если есть тесты для `apiPoll`, `poll()`, `getSinceId()` — удалить их тоже.

## Шаг 4: Финальная очистка

Если всё работает:
```bash
rm -rf Удоли
rm CLEANUP.md
```

## Шаг 5: Коммит

```bash
git add .
git commit -m "chore: удалён polling код после миграции на WebSocket"
git push
```
